(function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}};e=angular.module("ngPintura",[]),c=function(){function a(a,b,c){var d,e,g,h;for(this.files=null!=a?a:[],this.loadedCb=b,this.progressCb=c,this.onload=f(this.onload,this),this.loaded=0,h=this.files,e=0,g=h.length;e<g;e++)d=h[e],d.image=new Image,d.image.onload=this.onload,d.image.src=d.url}return a.prototype.onload=function(){if(this.loaded+=1,this.progressCb&&this.progressCb(this.loaded/this.files.length),this.loaded>=this.files.length)return this.loadedCb(this.files)},a}(),a=function(){function a(){var a,c,e,f;f=new Konva.Stage({container:angular.element("<div>")[0]}),e=new Konva.Layer,a=new Konva.Image,c=new Konva.Rect,f.add(e),e.add(a),e.add(c),this.progressCb=void 0,this.stage=f,this.layer=e,this.image=new b(a),this.indicator=new d(c)}return a.prototype.resize=function(a,b){return this.stage.size({width:a,height:b}),this.indicator.node.position({x:a/2,y:b/2}),this.image.adjustScaleBounds(this.stage.size())},a.prototype.imageChange=function(a,b){return this.image.node.visible(!1),(angular.isUndefined(b)||b)&&(this.indicator.node.visible(!0),this.indicator.animation.start()),"string"==typeof a?Konva.Image.fromURL(a,function(a){return function(b){return a.setImage(b.image()),b.destroy()}}(this)):a instanceof Image?this.setImage(a):a instanceof Array?this.setCollage(a):window.console?console.log("src is empty or unknown format:",a):void 0},a.prototype.setImage=function(a){return this.image.node.size({width:a.width,height:a.height}),this.image.node.image(a),this.indicator.node.visible(!1),this.indicator.animation.stop(),this.image.adjustScaleBounds(this.stage.size()),this.image.node.visible(!0),this.image.node.parent.draw(),this.image.node.fire(this.image.LOADED)},a.prototype.setCollage=function(a){var b;return b=function(a){return function(b){var c,d,e,f,g,h;for(d=0,e=0,f=new Konva.Layer,g=0,h=b.length;g<h;g++)c=b[g],d=Math.max(c.x+1,d),e=Math.max(c.y+1,e),f.add(new Konva.Image({image:c.image,x:c.x*c.image.width,y:c.y*c.image.height}));return f.toImage({x:0,y:0,width:d*b[0].image.width,height:e*b[0].image.height,callback:function(b){return a.setImage(b),f.destroy()}})}}(this),new c(a,b,this.progressCb)},a}(),d=function(){function a(a){var b;this.node=a,this.rotationSpeed=270,this.node.setAttrs({width:50,height:50,fill:"pink",stroke:"white",strokeWidth:4,zIndex:99,visible:!1,offset:{x:25,y:25}}),b=function(a){return function(b){var c;return c=b.timeDiff*a.rotationSpeed/1e3,a.node.rotate(c)}}(this),this.animation=new Konva.Animation(b,this.node.parent)}return a}(),b=function(){function a(a){this.node=a,this.LOADED="loaded",this.node.draggable(!0),this.minScale=.5,this.maxScale=1,this.tween=void 0,this.tweenDuration=.25}return a.prototype.adjustScaleBounds=function(a){if(this.node.width()&&this.node.height())return this.minScale=a.width/this.node.width(),a.height<this.node.height()*this.minScale&&(this.minScale=a.height/this.node.height()),this.minScale=Math.min(this.minScale,1)},a.prototype._fitScale=function(a){return Math.min(Math.max(a,this.minScale),this.maxScale)},a.prototype.rotateByVectorTween=function(a,b){var c,d,e,f,g;if(d={width:this.node.width()*this.minScale,height:this.node.height()*this.minScale},c={offsetY:0,offsetX:0,scaleX:this.minScale,scaleY:this.minScale,x:d.width<this.node.getStage().width()?(this.node.getStage().width()-d.width)/2:0,y:d.height<this.node.getStage().height()?(this.node.getStage().height()-d.height)/2:0},e=this.node.rotation()+a,g=Math.round(Math.sin(e*Math.PI/180)),f=Math.round(Math.cos(e*Math.PI/180)),1===f?(c.offsetX=0,c.offsetY=0):f===-1?(c.offsetX=this.node.width(),c.offsetY=this.node.height()):1===g?(c.offsetX=this.node.width()/2-this.node.height()/2,c.offsetY=this.node.width()/2+this.node.height()/2):g===-1&&(c.offsetX=this.node.width()/2+this.node.height()/2,c.offsetY=-(this.node.width()/2-this.node.height()/2)),e!==this.node.rotation())return this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(c,{node:this.node,rotation:e,duration:.1,easing:Konva.Easings.EaseOut,onFinish:b})),this.tween.play()},a.prototype._zoomToPointAttrs=function(a,b){var c,d,e,f,g,h;return h=this.node.scaleX()+a,h=this._fitScale(h),d=this.node.getAbsoluteTransform().copy().invert().point(b),c={scaleX:h,scaleY:h},e=this.node.rotation(),g=Math.round(Math.sin(e*Math.PI/180)),f=Math.round(Math.cos(e*Math.PI/180)),1===f?(c.x=b.x-d.x*h,c.y=b.y-d.y*h):f===-1?(c.x=b.x-(this.node.width()-d.x)*h,c.y=b.y-(this.node.height()-d.y)*h):1===g?(c.x=b.x-(this.node.height()-d.y)*h-this.node.offsetX()*h,c.y=b.y-d.x*h+this.node.offsetX()*h):g===-1&&(c.x=b.x-d.y*h+this.node.offsetY()*h,c.y=b.y-(this.node.width()-d.x)*h-this.node.offsetY()*h),c},a.prototype.zoomToPoint=function(a,b){return this.node.setAttrs(this._zoomToPointAttrs(a,b)),this.node.parent.draw()},a.prototype.zoomToPointer=function(a){return this.zoomToPoint(a,this.node.getStage().getPointerPosition())},a.prototype._stageCenter=function(){var a;return a={x:this.node.getStage().width()/2,y:this.node.getStage().height()/2}},a.prototype.zoomToCenter=function(a){return this.zoomToPoint(a,this._stageCenter())},a.prototype.zoomToPointTween=function(a,b,c){var d;if(d=this._zoomToPointAttrs(a,b),a!==this.node.scaleX()||d.x!==this.node.x()||d.y!==this.node.y())return this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(d,{node:this.node,duration:this.tweenDuration,easing:Konva.Easings.EaseOut,onFinish:c})),this.tween.play()},a.prototype.zoomToCenterTween=function(a,b){return this.zoomToPointTween(a,this._stageCenter(),b)},a.prototype.moveByVectorTween=function(a,b){var c;if(c=this.node.position(),a.x&&(c.x+=a.x),a.y&&(c.y+=a.y),c.x!==this.node.x()||c.y!==this.node.y())return this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(c,{node:this.node,duration:this.tweenDuration,easing:Konva.Easings.EaseOut,onFinish:b})),this.tween.play()},a.prototype.fitInViewTween=function(a){var b,c;if(c={width:this.node.width()*this.minScale,height:this.node.height()*this.minScale},b={scaleX:this.minScale,scaleY:this.minScale,x:c.width<this.node.getStage().width()?(this.node.getStage().width()-c.width)/2:0,y:c.height<this.node.getStage().height()?(this.node.getStage().height()-c.height)/2:0},b.x!==this.node.x()||b.y!==this.node.y()||b.scaleX!==this.node.scaleX())return this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(b,{node:this.node,duration:this.tweenDuration,easing:Konva.Easings.EaseOut,onFinish:a})),this.tween.play()},a}(),e.directive("ngPintura",["$window",function(b){var c;return c={transclude:!0,scope:{src:"=ngpSrc",scaling:"=?ngpScaling",position:"=?ngpPosition",fitOnload:"=?ngpFitOnload",maxScaling:"=?ngpMaxScaling",scaleStep:"=?ngpScaleStep",mwScaleStep:"=?ngpMwScaleStep",showIndicator:"=?ngpShowIndicator",moveStep:"=?ngpMoveStep",progress:"=?ngpProgress"},link:function(c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r;return m=new a,c.slider={value:void 0,fromScaling:function(a){return this.value=parseInt((a-m.image.minScale)/(m.image.maxScale-m.image.minScale)*100)},toScaling:function(){return(m.image.maxScale-m.image.minScale)*(this.value/100)+m.image.minScale}},o=function(){return m.resize(d[0].clientWidth,d[0].clientHeight),q()},i=function(){return m.imageChange(c.src,c.showIndicator)},n=function(){var a,b;if((null!=(a=c.position)?a.x:void 0)&&(null!=(b=c.position)?b.y:void 0))return m.image.node.position(c.position),m.layer.draw()},p=function(){return m.image.node.scale({x:c.scaling,y:c.scaling}),m.layer.draw(),c.slider.fromScaling(c.scaling)},l=function(a){return a.evt.preventDefault(),a.evt.wheelDeltaY>0?m.image.zoomToPointer(c.mwScaleStep):m.image.zoomToPointer(-c.mwScaleStep),h()},r=function(){if(c.position=m.image.node.position(),c.scaling=m.image.node.scaleX(),c.slider.toScaling()!==c.scaling)return c.slider.fromScaling(c.scaling)},h=function(){return c.$apply(r)},c.fitInView=function(){return m.image.fitInViewTween(h)},c.moveUp=function(){return m.image.moveByVectorTween({y:c.moveStep},h)},c.moveDown=function(){return m.image.moveByVectorTween({y:-c.moveStep},h)},c.moveRight=function(){return m.image.moveByVectorTween({x:-c.moveStep},h)},c.moveLeft=function(){return m.image.moveByVectorTween({x:c.moveStep},h)},c.zoomIn=function(){return m.image.zoomToCenterTween(c.scaleStep,h)},c.zoomOut=function(){return m.image.zoomToCenterTween(-c.scaleStep,h)},c.rotateLeft=function(){return m.image.rotateByVectorTween(-90,h)},c.rotateRight=function(){return m.image.rotateByVectorTween(90,h)},c.sliderChange=function(){var a;return a=c.slider.toScaling()-m.image.node.scaleX(),m.image.zoomToCenter(a),r()},q=function(){return c.scalingDisabled=m.image.minScale>=m.image.maxScale},j=function(){return c.fitOnload&&c.fitInView(),q()},k=function(){return m.image.maxScale=c.maxScaling,q()},m.progressCb=function(a){return c.$apply(function(){return c.progress=a})},null==c.maxScaling&&(c.maxScaling=1),null==c.scaleStep&&(c.scaleStep=.4),null==c.mwScaleStep&&(c.mwScaleStep=.1),null==c.moveStep&&(c.moveStep=100),null==c.fitOnload&&(c.fitOnload=!0),d.append(m.stage.content),o(),angular.element(b).on("resize",o),c.$watch("src",i),c.$watch("position",n,!0),c.$watch("scaling",p),c.$watch("maxScaling",k),m.image.node.on("dragend",h),m.image.node.on("mousewheel",l),m.image.node.on(m.image.LOADED,j),g(c,function(a){return d.append(a)})}}}])}).call(this);